---
title: "NonPareil Diversity Anlaysis"
output: html_notebook
---


```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(cowplot)
library(Nonpareil)
```


# Get list of NonPareil outputs
```{r}
np_list <- list.files(path = "../../results/nonpareil_out", pattern='*\\.npo', recursive=TRUE, full.names=TRUE)
np_length <- length(np_list)
```

# Graph NonPareil Curves
```{r}
#pdf(file="../../results/notebook_out/00_NonPareilPlot.pdf")
Nonpareil.legend(Nonpareil.curve.batch(np_list, 
                                       plot.opts = list(legend = NA, 
                                                        plot.model = F, 
                                                        plot.diversity = F,
                                                        main = NA)), cex = 0.90)
Nonpareil.curve.batch(np_list, plot.opts = list(legend = NA, 
                                                        plot.model = F, 
                                                        plot.diversity = F,
                                                        main = NA))

#dev.off()
```

# Save NonPareil Summary
```{r}
## generate summary

np_summary <-as.data.frame(
                            summary(Nonpareil.curve.batch(np_list, plot = F))
                            )
#write_csv2(np_summary, "../../results/notebook_out/00_NonPareilSummary.csv")
np_summary
```

```{r}
## compute summary stats: mean, med, sd, se
mean(summary(Nonpareil.curve.batch(np_list, plot = F))[,2])
median(summary(Nonpareil.curve.batch(np_list, plot = F))[,2])
sd(summary(Nonpareil.curve.batch(np_list, plot = F))[,2])
sd(summary(Nonpareil.curve.batch(np_list, plot = F))[,2])/sqrt(np_length)

```
```{r}
np_summary %>%
  ggplot( aes(x=C)) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) + theme_q2r()

np_summary %>%
  ggplot( aes(x=diversity, y=C)) +
    geom_point() + theme_q2r()
```



```{r}
mgx <- read_csv("../../results/minimal_SCRIPT_01_Metagenomics.csv", name_repair = "universal")[1:11]

np.meta <- clusters %>% mutate(cluster_num = as.factor(cluster_num)) %>%
  left_join(shannon.cluster) %>%
  separate(name, into=c("pt", "tube"), sep = "-TUBE")

np.meta <- np.meta %>% left_join(mgx, by=c("tube" ="DNA.tube.ID" ))

np.mgx2amp<- np_summary %>% rownames_to_column() %>%
  left_join(np.meta, by=c("rowname"="Batch_sample")) %>% drop_na(tube)
#missing <- np.mgx2amp %>% filter(is.na(tube)) 
#mgx %>% filter(Batch_sample %in% missing$rowname)
ggplot(np.mgx2amp, aes(x=factor(cluster_num), y=C)) +
  geom_boxplot()


ggplot(np.mgx2amp, aes(x=value, y=C)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  nature_theme("Diag", "value") + 
  theme(aspect.ratio=1) 

ggscatter(np.mgx2amp, x = "value", y = "diversity", #facet.by="success", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "AMP Value", ylab = "NonPareil Value", title = "")
```


